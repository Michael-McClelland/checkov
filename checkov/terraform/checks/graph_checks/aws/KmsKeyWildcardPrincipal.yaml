---
metadata:
  id: CKV_AWS_333333
  name: "Ensure KMS key policy does not contain wildcard (*) principal"
  category: IAM
definition:
  or:
    - and:
      - cond_type: attribute
        resource_types:
          - aws_kms_key
        attribute: policy
        operator: exists
      - cond_type: attribute
        resource_types:
          - aws_kms_key
        attribute: "policy.Statement[?(@.Effect == 'Allow')].Principal[*]"
        operator: "jsonpath_not_equals"
        value: "*"
      - cond_type: "attribute"
        resource_types:
          - aws_kms_key
        attribute: "policy.Statement[?(@.Effect == 'Allow')].Principal.AWS[*]"
        operator: "jsonpath_not_equals"
        value: "*"
      - cond_type: "attribute"
        resource_types:
          - aws_kms_key
        attribute: "policy.Statement[?(@.Effect == 'Allow' & @.Principal == '*')]"
        operator: "jsonpath_not_exists"
    - and:
      - cond_type: "attribute"
        resource_types:
          - "data.aws_iam_policy_document"
        attribute: "statement[?(@.effect == Allow)].principals.identifiers[*]"
        operator: "jsonpath_not_equals"
        value: "*"
    - and:
      - cond_type: attribute
        resource_types:
          - aws_kms_key_policy
        attribute: "policy.Statement[?(@.Effect == 'Allow')].Principal[*]"
        operator: "jsonpath_not_equals"
        value: "*"
      - cond_type: "attribute"
        resource_types:
          - aws_kms_key_policy
        attribute: "policy.Statement[?(@.Effect == 'Allow')].Principal.AWS[*]"
        operator: "jsonpath_not_equals"
        value: "*"
      - cond_type: "attribute"
        resource_types:
          - aws_kms_key_policy
        attribute: "policy.Statement[?(@.Effect == 'Allow' & @.Principal == '*')]"
        operator: "jsonpath_not_exists"


    # - cond_type: "connection"
    #   resource_types:
    #         - "aws_kms_key"
    #   connected_resource_types:
    #         - "aws_kms_key_policy"
    #   operator: "exists"
    # - cond_type: "filter"
    #   attribute: "resource_type"
    #   operator: "within"
    #   value: "aws_kms_key"